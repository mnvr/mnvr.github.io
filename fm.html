<!DOCTYPE html>
<html lang="en">

<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width">

<title>fm | mnvr.in</title>
<meta name="description" content="">

<style>
:root {
  color-scheme: light dark;
}
div#seq {
  display: flex;
  margin-block: 0.5em;
  gap: 0.4em;
  div {
    width: 0.5em;
    aspect-ratio: 0.4;
    border: 1px solid color-mix(in srgb, currentColor 50%, transparent);
  }
  div.on {
    background-color: color-mix(in srgb, currentColor 70%, transparent);
  }
}
.row {
  display: flex;
  align-items: center;
  gap: 1em;
}
</style>

<script type="module">
let audioContext;
let isOn;

const onOff = (e) => {
  const btn = e.target;

  if (!audioContext) {
    audioContext = new AudioContext();
    createAudioGraph();
  }

  isOn = !isOn;
  btn.innerText = isOn ? "Off" : "On";

  if (isOn) {
    audioContext.resume();
    startSequencer();
  } else {
    audioContext.suspend();
  }
}

let osc1;
let amp1;
let analyser1;

const createAudioGraph = () => {
  osc1 = new OscillatorNode(audioContext, {

  });
  amp1 = new GainNode(audioContext, { gain: 0 });
  osc1.connect(amp1)
  osc1.start();

  analyser1 = new AnalyserNode(audioContext);
  amp1.connect(analyser1);

  const mix = new GainNode(audioContext, { gain: 0.1 });
  amp1.connect(mix);

  mix.connect(audioContext.destination);
}

const timeOutput = document.querySelector("output#time");
const tickOutput = document.querySelector("output#tick");
const tickTimeOutput = document.querySelector("output#tickTime");
const bpm = 140;
const bps = bpm / 60;
const tickTime = 1 / bps;
let tick = -1;

const canvas1 = document.querySelector("canvas#c1");

const seq = []

const startSequencer = () => {
  tickTimeOutput.innerText = tickTime.toFixed(3);

  const sl = seq.length;

  let samples1;
  if (!samples1) {
    samples1 = new Float32Array(analyser1.fftSize);
  }

  const loop = () => {
    if (!isOn) return;

    const t = audioContext.currentTime;

    timeOutput.innerText = t.toFixed(1);
    requestAnimationFrame(loop);

    analyser1.getFloatTimeDomainData(samples1);
    const canv1 = canvas1.getContext("2d");
    const cy = (x) => rescale(x, [-1, 1], [0, canvas1.clientHeight]);
    canv1.clearRect(0, 0, canvas1.clientWidth, canvas1.clientHeight);
    canv1.strokeStyle = "black";
    canv1.beginPath();
    canv1.moveTo(0, cy(0));
    for (let i = 0; i < Math.min(samples1.length, canvas1.clientWidth); i++) {
      canv1.lineTo(i, cy(samples1[i]));
    }
    canv1.stroke();

    const thisTick = Math.floor(t / tickTime);
    if (thisTick == tick) return;
    tick = thisTick;

    tickOutput.innerText = tick + 1;

    seq[(sl + tick - 1) % sl].classList.remove("on");

    const si = tick % sl;
    seq[si % sl].classList.add("on");

    amp1.gain.setTargetAtTime(1, t, 0.001);
    amp1.gain.setTargetAtTime(0, t + 0.001, tickTime / 5);
    amp1.gain.setValueAtTime(0, t + tickTime / 2);
    // amp1.gain.setTargetAtTime(0, t + 0.05, 0.5)

  };

  requestAnimationFrame(loop);
}

const rescale = (x, [a, b], [c, d]) => ((x - a) / (b - a)) * (d - c) + c;

document.querySelector("button").addEventListener("click", onOff);
const seqD = document.querySelector("#seq");
for (let i = 0; i < 16; i++) {
  const div = document.createElement("div");
  div.setAttribute("data-i", i);
  seqD.appendChild(div);
  seq.push(div);
}
</script>

</head>

<body>

<button>On</button>
<output id="time"></output>
<output id="tick"></output>

<div class="row">
<div id="seq"></div>
<output id="tickTime"></output>
</div>

<canvas id="c1"></canvas>


</body>
</html>
