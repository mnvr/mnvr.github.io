<!DOCTYPE html>
<html lang="en">

<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width">

<title>fm | mnvr.in</title>
<meta name="description" content="">

<style>
</style>

<script type="module">
let audioContext;
let isOn;

const onOff = (e) => {
  const btn = e.target;

  if (!audioContext) {
    audioContext = new AudioContext();
    createAudioGraph();
  }

  isOn = !isOn;
  btn.innerText = isOn ? "Off" : "On";

  if (isOn) {
    audioContext.resume();
    startSequencer();
  } else {
    audioContext.suspend();
  }
}

let osc1;
let amp1;

const createAudioGraph = () => {
  osc1 = new OscillatorNode(audioContext, {

  });
  amp1 = new GainNode(audioContext);
  osc1.connect(amp1)
  osc1.start();

  const mix = new GainNode(audioContext, { gain: 0.1 });
  amp1.connect(mix);

  mix.connect(audioContext.destination);
}

const timeOutput = document.querySelector("output#time");
const tickOutput = document.querySelector("output#tick");
const bpm = 140;
const bps = 60 / bpm;
let tick = -1;

const startSequencer = () => {
  const loop = () => {
    if (!isOn) return;

    timeOutput.innerText = audioContext.currentTime.toFixed(1);
    requestAnimationFrame(loop);

    const thisTick = Math.floor(audioContext.currentTime / bps);
    if (thisTick == tick) return;
    tick = thisTick;

    tickOutput.innerText = tick;
  };

  requestAnimationFrame(loop);
}

document.querySelector("button").addEventListener("click", onOff);
</script>

</head>

<body>

<button>On</button>
<output id="time"></output>
<output id="tick"></output>

</body>
</html>
