<!DOCTYPE html>
<html lang="en">

<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width">

<title>Mandelbrot sets | mnvr.in</title>
<meta name="description" content="">

<style>
:root {
  color-scheme: light dark;
}
body {
  max-width: 37rem;
}
canvas {
  border: 1px solid tomato;
  width: 100%;
  aspect-ratio: 2;
  display: block;
}
</style>

<script type="module">

// Mandelbrot set
//
// - Iterate, for each c,
// - z = z^2 + c
// - start z = 0
//
// Complex multiplication / squaring  [x, y]:
//
//     (a + ib) * (c + id)
//     (a * c) + (ib * c) + (a * id) + (ib * id)
//     (a * c) + (ib * c) + (a * id) - (b * d)
//     (a * c - b * d) + i(b * c + a * d)
//     (x * x - y * y) + i (2 * x * y)
//
const step = ([x, y], [cx, cy]) => [x * x - y * y + cx, 2 * x * y + cy]

// c is part of set if iteration does not diverge.
//
// - 100 is an arbitrary threshold of iterations that seem to work.
// - Math tells us that if z exceeds 2, it'll diverge (early return).
const mb = (c, iter) => {
  let z = [0, 0]
  for (let i = 0; i < (iter ?? 100); i++) {
    z = step(z, c);
    if (z.some(x => Math.abs(x) > 2)) return i;
  }
  return true; // should we?
  // return z.every(x => Math.abs(x) < 1);
}

// Rescale x from [a, b] to [c, d]
const rescale = (x, [a, b], [c, d]) => ((x - a) / (b - a)) * (d - c) + c

const plot = (canvas, output, xrange, yrange, iter = 100) => {
  const dpr = Math.max(Math.floor(devicePixelRatio), 2);
  const width = canvas.width = canvas.clientWidth * dpr;
  const height = canvas.height = canvas.clientHeight * dpr;
  output.innerText = JSON.stringify([...xrange, ...yrange]);

  const ctx = canvas.getContext("2d");
  const imageData = ctx.getImageData(0, 0, width, height);
  const data = imageData.data;

  for (let y = 0; y < height; y++) {
    for (let x = 0; x < width; x++) {
      const i = (y * width + x) * 4; /* RGBA */
      const c = [
        rescale(x, [0, width], xrange), rescale(y, [0, height], yrange)
      ]

      data[i + 0] = 0;
      data[i + 1] = 0;

      const z = mb(c, iter);
      if (z === true) {
        data[i + 2] = 255;
        data[i + 3] = 255;
      } else {
      if (iter > 200 && z > 100) {
        data[i + 2] = 255;
        if (z > 280) {
          data[i + 3] = (255 - z) / 2;
        } else if (z > 180) {
          data[i + 3] = 255 - z;
        } else if (z > 120) {
          data[i + 3] = z / 2;
        } else {
          data[i + 3] = z / 8;
        }
      }
      }

      if (Math.floor(c[0]) === c[0] || Math.floor(c[1]) === c[1]) {
        data[i + 2] = 255;
        data[i + 3] = 255;
      }
    }
  }

  ctx.putImageData(imageData, 0, 0);
}

// Plot [(-2.5, 1.5), (-1, 1)]
// - Maintains aspect ratio.
// - Region of interest is towards the negative real axis.
// plot(
//   document.querySelector("#a canvas"), document.querySelector("#a output"),
//   [-2.5, 1.5], [-1, 1]
// )

// plot(
//   document.querySelector("#b canvas"), document.querySelector("#b output"),
//   [-1.5, 0.5], [-0.5, 0.5]
// )

// plot(
//   document.querySelector("#c canvas"), document.querySelector("#c output"),
//   [((-1.5-0.9)/8)-0.6, ((0.5-0.9)/8)-0.6], [(-0.75/8)+0.2, (0.35/8)+0.2]
// )

// const s = 38;
// const xo = 0.6975;
// plot(
//   document.querySelector("#d canvas"), document.querySelector("#d output"),
//   [((-1.5-0.9)/s)-xo, ((0.5-0.9)/s)-xo], [(-0.75/s)+0.2, (0.35/s)+0.2],
//   200
// )

(() => {
const s = 128;
const xo = 0.7175;
plot(
  document.querySelector("#d canvas"), document.querySelector("#d output"),
  [((-1.5-0.9)/s)-xo, ((0.5-0.9)/s)-xo], [(-0.75/s)+0.2, (0.35/s)+0.2],
  200
)
})();

(() => {
const s = 11718;
const xo = 0.73569;
plot(
  document.querySelector("#e canvas"), document.querySelector("#e output"),
  [((-1.5-0.9)/s)-xo, ((0.5-0.9)/s)-xo], [(-0.75/s)+0.19674, (0.35/s)+0.19674],
  510
)
})();
</script>

</head>

<body>

<p id="a">
<canvas></canvas>
<output></output>
</p>

<p id="b">
<canvas></canvas>
<output></output>
</p>

<p id="c">
<canvas></canvas>
<output></output>
</p>

<p id="d">
<canvas></canvas>
<output></output>
</p>

<p id="e">
<canvas></canvas>
<output></output>
</p>

</body>
</html>
