<!DOCTYPE html>
<html lang="en">

<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width">

<title>Template | mnvr.in</title>
<meta name="description" content="">
<link href="paper.css" rel="stylesheet">

<style>
:root {
  --accent: pink;
}
canvas {
  border: 1px solid tomato;
  width: 100%;
  aspect-ratio: 2;
}
</style>

<script type="module">

// Mandelbrot set
//
// - Iterate, for each c,
// - z = z^2 + c
// - start z = 0
//
// Complex multiplication / squaring  [x, y]:
//
//     (a + ib) * (c + id)
//     (a * c) + (ib * c) + (a * id) + (ib * id)
//     (a * c) + (ib * c) + (a * id) - (b * d)
//     (a * c - b * d) + i(b * c + a * d)
//     (x * x - y * y) + i (2 * x * y)
//
const step = ([x, y], [cx, cy]) => [x * x - y * y + cx, 2 * x * y + cy]

// c is part of set if iteration does not diverge.
//
// - 100 is an arbitrary threshold of iterations that seem to work.
// - Math tells us that if z exceeds 2, it'll diverge (early return).
const mb = (c) => {
  let z = [0, 0]
  for (let i = 0; i < 100; i++) {
    z = step(z, c);
    if (z.some(x => Math.abs(x) > 2)) return false;
  }
  return true; // should we?
  // return z.every(x => Math.abs(x) < 1);
}

// Rescale x from [a, b] to [c, d]
const rescale = (x, [a, b], [c, d]) => ((x - a) / (b - a)) * (d - c) + c

const canvas = document.querySelector("canvas");
const output = document.querySelector("output");
const dpr = Math.max(Math.floor(devicePixelRatio), 2);
const width = canvas.width = canvas.clientWidth * dpr;
const height = canvas.height = canvas.clientHeight * dpr;
output.innerText = JSON.stringify([width, height]);

const ctx = canvas.getContext("2d");
ctx.strokeStyle = "tomato";
ctx.beginPath();
ctx.moveTo(0, 0);
ctx.lineTo(width, height);
ctx.closePath();
ctx.stroke();

const imageData = ctx.getImageData(0, 0, width, height);
const data = imageData.data;
let c1 = 0; let c2 = 0;
for (let i = 0; i < data.length; i += 4) {
  // console.log("c", i, data[i], data[i + 1], data[i + 2], data[i + 3])
  if ((data[i]+ data[i + 1]+ data[i + 2]+ data[i + 3]) == 0) {
    c1++;
  } else {
    c2++;
  }
}
console.log({c1, c2});

let k1 = 0; let k2 = 0;
for (let y = 0; y < height; y++) {
  for (let x = 0; x < width; x++) {
    const i = (y * width + x) * 4;
    if ((data[i]+ data[i + 1]+ data[i + 2]+ data[i + 3]) == 0) {
      k1++;
    } else {
      k2++;
    }

    // Plot [(-2.5, 1.5), (-1, 1)]
    // - Maintain aspect ratio.
    // - Region of interest is towards the negative real axis.
    const c = [rescale(x, [0, width], [-2.5, 1.5]), rescale(y, [0, height], [-1, 1])]

    // console.log(c);
    if (mb(c)) {

      data[i + 2] = 255;
      data[i + 3] = 255;
    }
    if (Math.floor(c[0]) === c[0] || Math.floor(c[1]) === c[1]) {
      data[i + 2] = 255;
      data[i + 3] = 255;
    }
  }
}
console.log({k1, k2});
console.log([imageData.width, imageData.height])

ctx.putImageData(imageData, 0, 0);

</script>

</head>

<body>

<p>
<canvas></canvas>
</p>
<p>
<output></output>
</p>

</body>
</html>
